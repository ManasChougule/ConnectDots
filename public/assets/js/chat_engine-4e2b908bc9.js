class ChatEngine{constructor(s,e,t){const{hostname:o}=window.location;this.chatBox=$(`#${s}`),this.userEmail=e,this.to_user=t,this.socket=io.connect(`http://${o}:5000`,{transports:["polling"]}),console.info(`Websoket listing on http://${o}:5000`),this.userEmail&&(this.fetchPreviousMessages(),this.connectionHandler())}async fetchPreviousMessages(){try{const s=await fetch(`/chat/getPreviousMessages/${this.to_user}/`),e=await s.json();e.messages&&(e.messages.forEach((s=>{this.displayMessage(s)})),this.scrollChatToBottom())}catch(s){console.error("Error fetching previous messages:",s)}}scrollChatToBottom(){var s=document.getElementById("chat-messages-list");s&&(s.scrollTop=s.scrollHeight)}splitMessage(s,e){const t=[],o=s.split(" ");let a="";for(const s of o)if(a.length+s.length<=e)a+=s+" ";else if(s.length<=e)t.push(a.trim()),a=s+" ";else{let o=0;for(;o<s.length;)t.push(s.substring(o,o+e)+"-"),o+=e;let n=t.pop();n=n.substring(0,n.length-1),a=n+" "}return a&&t.push(a.trim()),t}displayMessage(s){const e=s.user_email===this.userEmail,t=s.message,o=this.splitMessage(t,10),a=$("<li>").addClass("d-flex flex-column mb-4").addClass(e?"justify-content-end":"justify-content-start"),n=$("<div>").addClass("p-2 ms-3").css({borderRadius:"15px",backgroundColor:e?"#a0dcff":"#ffa0a0"});if(o.forEach((s=>{const e=$("<p>").addClass("small mb-0").text(s);n.append(e)})),a.append(n),!e){const e=$("<div>").addClass("chat-sender-email").text(s.user_email);a.append(e)}$("#chat-messages-list").append(a),this.scrollChatToBottom()}connectionHandler(){let s=this;this.socket.on("connect",(function(){console.log("connection established using sockets...!",s.userEmail&&null==s.to_user,null==s.to_user,s.userEmail,s.to_user),s.userEmail&&null==s.to_user?s.socket.emit("join_room",{user_email:s.userEmail,chatroom:"EternalEchoes",to_user:null}):s.socket.emit("join_personal_room",{user_email:s.userEmail,chatroom:"ConnectDots_Personal",to_user:s.to_user}),s.socket.on("user_joined",(function(s){})),s.socket.on("user_joined2",(function(s){}))})),$("#send-message").click((function(){let e=$("#InputMessage").val();""!==e&&e.length<=100?(null==s.to_user?s.socket.emit("send_message",{message:e,user_email:s.userEmail,chatroom:"EternalEchoes",to_user:null}):s.socket.emit("send_message2",{message:e,user_email:s.userEmail,chatroom:"ConnectDots_Personal",to_user:s.to_user}),$("#InputMessage").val("")):displayFlashMessage(""==e?"Message is empty!!!":"Message length should be less than 100",!0)})),$("#InputMessage").keydown((function(s){"Enter"===s.key&&(s.preventDefault(),$("#send-message").click())})),this.socket.on("receive_message",(function(e){s.displayMessage(e)})),this.socket.on("receive_message2",(function(e){e.user_email!=s.to_user&&e.user_email!=s.userEmail||s.displayMessage(e)}))}}function displayFlashMessage(s,e){new Noty({theme:"relax",text:`${s}`,type:"error",layout:"topRight",timeout:1500}).show(),$("#InputMessage").val("")}