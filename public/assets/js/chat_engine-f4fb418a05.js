class ChatEngine{constructor(e,s,t){const{hostname:o,protocol:a}=window.location;this.chatBox=$(`#${e}`),this.userEmail=s,this.to_user=t,this.socket=io(`${a}//${o}`,{path:"/socket.io",transports:["websocket","polling"],withCredentials:!0}),console.info(`Websocket listing on ${a}//${o}`),this.userEmail&&(this.fetchPreviousMessages(),this.connectionHandler())}async fetchPreviousMessages(){try{const e=await fetch(`/chat/getPreviousMessages/${this.to_user}/`),s=await e.json();s.messages&&(s.messages.forEach((e=>{this.displayMessage(e)})),this.scrollChatToBottom())}catch(e){console.error("Error fetching previous messages:",e)}}scrollChatToBottom(){var e=document.getElementById("chat-messages-list");e&&(e.scrollTop=e.scrollHeight)}splitMessage(e,s){const t=[],o=e.split(" ");let a="";for(const e of o)if(a.length+e.length<=s)a+=e+" ";else if(e.length<=s)t.push(a.trim()),a=e+" ";else{let o=0;for(;o<e.length;)t.push(e.substring(o,o+s)+"-"),o+=s;let n=t.pop();n=n.substring(0,n.length-1),a=n+" "}return a&&t.push(a.trim()),t}displayMessage(e){if(!e||"object"!=typeof e)return;const s=e.user_email===this.userEmail,t=e?.message||"",o=this.splitMessage(t,10),a=$("<li>").addClass("d-flex flex-column mb-4").addClass(s?"justify-content-end":"justify-content-start"),n=$("<div>").addClass("p-2 ms-3").css({borderRadius:"15px",backgroundColor:s?"#a0dcff":"#ffa0a0"});if(o.forEach((e=>{const s=$("<p>").addClass("small mb-0").text(e);n.append(s)})),a.append(n),!s){const s=$("<div>").addClass("chat-sender-email").text(e.user_email);a.append(s)}$("#chat-messages-list").append(a),this.scrollChatToBottom()}connectionHandler(){let e=this;this.socket.on("connect",(function(){console.log("connection established using sockets...!"),e.userEmail&&null==e.to_user?e.socket.emit("join_room",{user_email:e.userEmail,chatroom:"EternalEchoes",to_user:null}):e.socket.emit("join_personal_room",{user_email:e.userEmail,chatroom:"ConnectDots_Personal",to_user:e.to_user}),e.socket.on("user_joined",(function(e){})),e.socket.on("user_joined2",(function(e){}))})),$("#send-message").click((function(){let s=$("#InputMessage").val();""!==s&&s.length<=100?(null==e.to_user?e.socket.emit("send_message",{message:s,user_email:e.userEmail,chatroom:"EternalEchoes",to_user:null}):e.socket.emit("send_message2",{message:s,user_email:e.userEmail,chatroom:"ConnectDots_Personal",to_user:e.to_user}),$("#InputMessage").val("")):displayFlashMessage(""==s?"Message is empty!!!":"Message length should be less than 100",!0)})),$("#InputMessage").keydown((function(e){"Enter"===e.key&&(e.preventDefault(),$("#send-message").click())})),this.socket.on("receive_message",(function(s){e.displayMessage(s)})),this.socket.on("receive_message2",(function(s){s.user_email!=e.to_user&&s.user_email!=e.userEmail||e.displayMessage(s)}))}}function displayFlashMessage(e,s){new Noty({theme:"relax",text:`${e}`,type:"error",layout:"topRight",timeout:1500}).show(),$("#InputMessage").val("")}